# DispatchSemaphore 사용하기

> DispatchQueue를 사용하여 비동기적은 코드를 순차적으로 처리해보고,
>
> 여기 교착상태가 발생했을 경우의 해결과정을 정리해봤음

## 1.  DispatchSemaphore을 사용해서 Alamofire의 여러 요청을 순차적으로 처리하기

- Alamofire을 사용하면, 요청을 보낸 후 응답을 비동기적으로 처리한다.

- Alamofire의 비동기적인 응답 처리는 아래와 같이 메인큐에서 실행된다.

  ```swift
  DispatchQueue.main.async {}
  ```

- 아래와 같이 여러 productId를 가지고 순차적으로 요청을 보낸 후, 순차적으로 응답을 모두 받은 후에 메소드를 리턴하는 식으로 코드를 작성하고자 하였다.
- 우선, Alamofire의 응답이 비동기적으로 처리되기 때문에, 응답을 받기 전에 메소드가 리턴되는 문제가 발생했다.
- 이를 해결하고자 __`DispatchQueue`__ 를 사용하여, 임계영역을 설정해서 응답을 모두 순차적으로 받은 후에 메소드를 리턴하도록 하였다.



## 2. 메인 큐에서의 교착상태 발생 및 해결

- 위와 같이 여러 요청을 순차적으로 처리했지만, 문제는 Alamofire의 최종적인 응답 처리는 메인 큐에서 비동기적으로 수행되기 때문에 다른 메인 큐의 비동기 처리와 엇갈려서 교착상태가 발생해버렸다.
- 보통 DispatchQueue 사용 시에 아래와 같은 상황이 발생하면 교착상태가 발생한다.

```swift
let queue = DispatchQueue(label: "test")
//큐 안에 특정 작업을 비동기적으로 수행하도록 넣음
queue.async {
  	//비동기적으로 수행될 작업 내에는, 동일한 큐 내에서 동기적으로 수행해야 될 작업을 넣는 로직이 포함된 상태
    queue.sync {
      	//비동기적으로 수행되야 할 작업은, 내부의 동기적으로 수행되야 할 작업이 끝나기를 기다려야 함
      	//하지만, 내부에서 동기적으로 수행되야 할 작업은 당연히 외부의 비동기적인 작업이 끝나기 전까지 실행될 수 없음
      	//작업 큐에는 외부의 비동기적인 작업이 먼저 들어왔기 때문 
    }
    // 위의 논리대로면 해당 부분의 코드가 완전히 실행되야 하는데, 그렇지 못해서 교착상태가 발생하는 것
}
```

- __`DispatchSemaphore`__ 을 사용해서 메인 큐의 비동기적인 작업 안에 사실상 메인 큐에서 동기적으로 실행되는 작업을 정의한 셈이 되었기 때문에 위와 같이 교착상태가 발생해버린 것!

- 결과적으로 동일한 큐에 작업을 할당해서 발생한 문제였기 때문에 글로벌 큐에 작업을 할당함으로써 이를 해결했다.
- 혹은 Alamofire의 응답 처리를 위한 비동기 큐를 별도로 설정해줘도 된다.