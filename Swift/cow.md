## Swift Copy On Write(COW)의 동작 알아보기

> 2022.03.02

### 이전까지 학습한 내용 상기

- Swift에서 클래스는 참조타입, 구조체는 값타입이다.
- 참조타입 인스턴스를 어떤 메소드의 파라미터로 넘기면 참조값을 넘기지만 값타입 인스턴스를 넘길 경우에는 복사된 값을 넘기게 된다.

```swift
let structExample:[Int] = [1,2,3]

func append(_ array: [Int])-> [Int]{
  var temp = array
  temp.append(10)
  return temp
}

append(structExample)
```

- 위와 같은 값타입에 해당하는 배열을 메소드의 파라미터로 넘기는 코드가 있다고 가정했을 때, 배열의 참조값이 아닌 복사된 배열이 파라미터로 넘어가는 것!

​        

### Swift에서의 Copy On Write

- 하지만 만일 __값타입 인스턴스의 크기가 큰 경우라면 매번 복사 연산을 수행하는 것 매우 비효율적일 것__
- 표준 Swift 라이브러리는 이를 극복하고자 값타입 인스턴스에 대해, __값타입 인스턴스의 데이터에 변경이 발생했을 때에만 실제로 복사하는 기법을 적용__ 하였으며 이를 가리켜 __`Copy On Write`__ 라고 부르는 것!
- 위와 같은 상황에서 값타입 인스턴스를 넘겼을 때, 바로 값을 복사하지 않고 __우선 동일한 값을 참조하도록 한 상태로 뒀다가 추후 데이터의 변경이 발생하면( `write` ) 이를 복사해 값을 변경하는 것!__

```swift
func append(_ array: [Int])-> [Int]{
  var temp = array //동일한 영역을 참조하는 상황
  temp.append(10) //값의 수정일 일어나서 새로운 영역에의 복사가 필요한 상황
  return temp
}
```

- 위의 상황에서 __`var temp = array`__ 까지는 array와 temp는 동일한 주소를 가리키지만, __`temp.append(10)`__ 으로 인해 배열값에 변경이 일어나면 array와 temp가 서로 다른 주소를 가리키게 될 것

​    

### 운영체제에서의 Copy On Write

> 찾아보니 Copy On Write는 운영체제에서 언급되는 개념 중 하나였다.
>
> 어떤 식으로 사용되는 지 추가적으로 찾아봄..

<img src="https://blog.kakaocdn.net/dn/4Mt2c/btqBDbs2gth/nqrakXv9TfLxSYbZtrNvH0/img.png" alt="image" style="width: 60%;"/>

- 위에서 살펴본대로 Copy On Write의 개념은 복사할 대상을 처음부터 복사하지 않고 동일하게 가지고 있다가(사실상 공유), 복사할 대상의 변경이 일어나는 경우에만 실제로 복사가 일어나는 것이었음
- 운영체제에서는 메모리 관리 시 최적화 기법 중 하나로 Copy On Write를 적용하고 있음
- 여러 프로세스가 존재한다고 했을 때 __몇몇 프로세스가 동일한 자원을 공유__ 하는 경우가 있을텐데, __메모리 공간의 한계로 인해 모든 프로세스가 각각의 자원을 위한 공간을 가지는 것은 비효율적임__
  - 프로세스가 자원을 공유하는 대표적인 예시로 __부모 프로세스가 자식 프로세스를 분기하는 경우__ 를 생각해볼 수 있을 것
- 보통 자식 프로세스가 부모 프로세스로 부터 분기&복제(__`fork`__)된 후 실행(__`exec`__)된 후 쓰임이 끝나면 메모리에서 자식 프로세스가 제거될텐데, __매번 복제될 때마다 부모 프로세스가 가지고 있던 자원을 복제하여 할당&해제 하는 과정이 반복된다면 매우 비효율적인 셈__ 
- 따라서 이러한 경우에는 Copy On Write를 적용하여 __동일한 자원을 공유하더라도, 자원에 대한 수정이 요구되는 상황에만 이를 복사하여 효율성을 제고__

- 좀 더 자세한 내용은 투머치라 이쯤 하고, 추후 운영체제의 가상메모리 관리 부분을 살펴보면 될듯하다!